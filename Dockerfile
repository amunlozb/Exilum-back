# Use the official Maven/Java 17 image to create a build artifact.
# https://hub.docker.com/_/maven
FROM maven:3.8.4-openjdk-17-slim AS build-env

# Set the working directory to /app
WORKDIR /app

# Copy the pom.xml file to download dependencies
COPY pom.xml ./

# Copy local code to the container image.
COPY src ./src

ARG SERVICE_ACCOUNT=ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAiZXhpbHVtLTJiN2Q0IiwKICAicHJpdmF0ZV9rZXlfaWQiOiAiNjcwNjE2ZWM4M2VlZWZmMTZjNDcwNjVhY2FmYTgxMmRkZmU2MjI5ZiIsCiAgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxuTUlJRXZRSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS2N3Z2dTakFnRUFBb0lCQVFDci9CaXZiK09XZGRxMFxuaFJOUjF3Vlk4bFpmdUc1K2h2VWNQendkQmRjRVAzekNNV2V3U0N5WGFadkxnRXlOcjRYK0NtVWtLZzlMQzZKOFxuWlFLRGRBb1JjdTMvVjVrWjVwNWFIdDlGdjJUbjVTNEpwSkV4aDJPUDJRK1VKRDVzVm1KQU8xSWpEZFd4OThOOFxuTFluV3h0c0s4R0tZRWxHSzB2SDRKQURQVEd5SnN6alg5Q1FmNkJSbjVOZDd4MHpCbUNpOG5HeUNCZVNDeldtTlxucEZLUTk4Wmdsc3ZCcW1iMzRUMGxISXY1emNJVElORUh5TmF3OHhPclZhSkUvWDAzcXNxRVdUWUtUNHBseitYblxuOWovR2NsZWRpOUJCTWhYb0lSZkVIOVVZbng4eVlldmJkR3RCemt5WTgrRUdIdXZibUtMcWVTUUsrSDBsVExYSFxuejNBcjdqZmZBZ01CQUFFQ2dnRUFKRG52UnpEMXl2RWJOdEFiSUM5L0VGdkhadFUxN1EvblhHSlRlcmVLc1huZ1xuQVJXZ0JpbEZ2MFQvREpBRFVBcnJXZlg5bE84SkZxRW1RamFTbjNiWFVoS1g0Q09tKzZZd3I4SDEvTDZTZGlnM1xubU05aHlBR0JMc0VsZjJwYy9idjZhUlkxdUcySEdEd2NvTEVFNmtrcnhYT2FDUGMrMXRPVkpWUU1HWjQ2OUl3RFxud2tSQUg4M2NmdzNUL3pRWkZiOFlLcXFjM05CcjVLbEVvbStCSlo5M3BKNVdnVUlVOGxaUXRLU1dGeHlmTnVCRFxuOGhGajRENDBLQmJMeCtSZFJPMWlhbFhrNnhpQytGODhnN3hXOWtSSDFMODRzZWxqVU41Z2dqT0EwR09ZNWM0alxuSkVjZnBRcUFYRGZMSE1GS29tVVZLbTkzQ2lSYWRjT2V1NElORmtYMzdRS0JnUURkejZVbmZ0Y3g1ZkRVM3orOFxudFJhbnpSVUdqM251d0hOSFcreGlSdkRpOXpwK2JwUk5lQmcwcmgzSDUzVnpyVjNSYTAwcTlNOXVPMGNKZ1FsbVxuOTdsb2szcExHRzhWL3k5ZVZ3KzhOcnZwZER1QnhrblFLN0tjOURYYXd2Rkl1MzJHeDRXakQrb2h2dXVwRTFoWlxuejE1Vml0dU94QzF1cGgwVHVVb0dPREN4cXdLQmdRREdmbCtBdlkwRWJXc09pMXI4TnF4VExsekRjM2tybnVSRVxuYzZSck9DOVBrQUlOVlpqM01Xa2VnK1dZc1NYNnJYY1BzNjBmQ3hLOFFHT0lwWW1ac3NUSkdkSXA0RnAxZW9mc1xuUVQ2V2s3UlorL2lTb1J1WmtBRVQ0MFBmZHlkaUxveDV1cHQ5Y3BBcGJjL1JiRlo2ci9JRjhzWkFobjhESlRKUVxuRTkyMERQWEduUUtCZ1FDUEkxUjhyRW5LbFl4WWtzamF5akdZajZ1bDFDam5mYUhteHRkQWhHOG15RXdqRXRENVxuUFNyQnRDcmJ1ZTM5ZkQ4eXlYKyszTVNQYWdscGhLL0FsdFE3UEJDTExYVmlTSThVM2pIMVQ0enNGbW5nVVVtSVxuNE9vZWh5bkp4a3RXbUVkbEZwU1NxYzU1Z0c4cmFLUjNNRzY3M1NQYWVaYW45T0tHdStlZEk5Mm9pUUtCZ0ZTWVxuYVdWNTQ0N2VmMEQ4blhOZWJjVXB2amxDam9MTHZpZDZUYm13Z1dGY1U3T1JKcGM3aEx5UHBCdVdiRVJSQjZ3MlxuZkhMOWlpZVhIWlNRVUh1ajJBQ0pNNnZMUldKS0xZSEFNTWVGL2RoWDdoRzMvZ1pOZkZnWWhNWEpoNHh0b0VzRVxuLzkzUUpLYXplVjJjMmFLQ09Calc1aTE3NU1mWFk0RURabnFsQjE1MUFvR0FJeTRHMXlwTVVDQzV5OUpDSW5CeFxuREthU2JMQkRyUTMvUHJBUEh5MEJoN0RzMFRVNnhUWUUyK3RZdUFnVm1FcW1jUkZYNlQ3VWtxb0tOZGltL29Va1xuVi8wZzZkZk5DN0MrTTVSd0ZWV2tkT0ZBemZ4YnhqY2FrVlR3TVQyZ1haRStwb0luNmxyaitzanpqczBjNjZMVlxucU1NSWhVbTMvZW5Pa0ppM2NqWlorSG89XG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLAogICJjbGllbnRfZW1haWwiOiAiZmlyZWJhc2UtYWRtaW5zZGstYXJrNWdAZXhpbHVtLTJiN2Q0LmlhbS5nc2VydmljZWFjY291bnQuY29tIiwKICAiY2xpZW50X2lkIjogIjExNTg0MDg5MjE0MjAwOTI2ODE5NyIsCiAgImF1dGhfdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwKICAidG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwKICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsCiAgImNsaWVudF94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvZmlyZWJhc2UtYWRtaW5zZGstYXJrNWclNDBleGlsdW0tMmI3ZDQuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJ1bml2ZXJzZV9kb21haW4iOiAiZ29vZ2xlYXBpcy5jb20iCn0K

ENV SERVICE_ACCOUNT=ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAiZXhpbHVtLTJiN2Q0IiwKICAicHJpdmF0ZV9rZXlfaWQiOiAiNjcwNjE2ZWM4M2VlZWZmMTZjNDcwNjVhY2FmYTgxMmRkZmU2MjI5ZiIsCiAgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxuTUlJRXZRSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS2N3Z2dTakFnRUFBb0lCQVFDci9CaXZiK09XZGRxMFxuaFJOUjF3Vlk4bFpmdUc1K2h2VWNQendkQmRjRVAzekNNV2V3U0N5WGFadkxnRXlOcjRYK0NtVWtLZzlMQzZKOFxuWlFLRGRBb1JjdTMvVjVrWjVwNWFIdDlGdjJUbjVTNEpwSkV4aDJPUDJRK1VKRDVzVm1KQU8xSWpEZFd4OThOOFxuTFluV3h0c0s4R0tZRWxHSzB2SDRKQURQVEd5SnN6alg5Q1FmNkJSbjVOZDd4MHpCbUNpOG5HeUNCZVNDeldtTlxucEZLUTk4Wmdsc3ZCcW1iMzRUMGxISXY1emNJVElORUh5TmF3OHhPclZhSkUvWDAzcXNxRVdUWUtUNHBseitYblxuOWovR2NsZWRpOUJCTWhYb0lSZkVIOVVZbng4eVlldmJkR3RCemt5WTgrRUdIdXZibUtMcWVTUUsrSDBsVExYSFxuejNBcjdqZmZBZ01CQUFFQ2dnRUFKRG52UnpEMXl2RWJOdEFiSUM5L0VGdkhadFUxN1EvblhHSlRlcmVLc1huZ1xuQVJXZ0JpbEZ2MFQvREpBRFVBcnJXZlg5bE84SkZxRW1RamFTbjNiWFVoS1g0Q09tKzZZd3I4SDEvTDZTZGlnM1xubU05aHlBR0JMc0VsZjJwYy9idjZhUlkxdUcySEdEd2NvTEVFNmtrcnhYT2FDUGMrMXRPVkpWUU1HWjQ2OUl3RFxud2tSQUg4M2NmdzNUL3pRWkZiOFlLcXFjM05CcjVLbEVvbStCSlo5M3BKNVdnVUlVOGxaUXRLU1dGeHlmTnVCRFxuOGhGajRENDBLQmJMeCtSZFJPMWlhbFhrNnhpQytGODhnN3hXOWtSSDFMODRzZWxqVU41Z2dqT0EwR09ZNWM0alxuSkVjZnBRcUFYRGZMSE1GS29tVVZLbTkzQ2lSYWRjT2V1NElORmtYMzdRS0JnUURkejZVbmZ0Y3g1ZkRVM3orOFxudFJhbnpSVUdqM251d0hOSFcreGlSdkRpOXpwK2JwUk5lQmcwcmgzSDUzVnpyVjNSYTAwcTlNOXVPMGNKZ1FsbVxuOTdsb2szcExHRzhWL3k5ZVZ3KzhOcnZwZER1QnhrblFLN0tjOURYYXd2Rkl1MzJHeDRXakQrb2h2dXVwRTFoWlxuejE1Vml0dU94QzF1cGgwVHVVb0dPREN4cXdLQmdRREdmbCtBdlkwRWJXc09pMXI4TnF4VExsekRjM2tybnVSRVxuYzZSck9DOVBrQUlOVlpqM01Xa2VnK1dZc1NYNnJYY1BzNjBmQ3hLOFFHT0lwWW1ac3NUSkdkSXA0RnAxZW9mc1xuUVQ2V2s3UlorL2lTb1J1WmtBRVQ0MFBmZHlkaUxveDV1cHQ5Y3BBcGJjL1JiRlo2ci9JRjhzWkFobjhESlRKUVxuRTkyMERQWEduUUtCZ1FDUEkxUjhyRW5LbFl4WWtzamF5akdZajZ1bDFDam5mYUhteHRkQWhHOG15RXdqRXRENVxuUFNyQnRDcmJ1ZTM5ZkQ4eXlYKyszTVNQYWdscGhLL0FsdFE3UEJDTExYVmlTSThVM2pIMVQ0enNGbW5nVVVtSVxuNE9vZWh5bkp4a3RXbUVkbEZwU1NxYzU1Z0c4cmFLUjNNRzY3M1NQYWVaYW45T0tHdStlZEk5Mm9pUUtCZ0ZTWVxuYVdWNTQ0N2VmMEQ4blhOZWJjVXB2amxDam9MTHZpZDZUYm13Z1dGY1U3T1JKcGM3aEx5UHBCdVdiRVJSQjZ3MlxuZkhMOWlpZVhIWlNRVUh1ajJBQ0pNNnZMUldKS0xZSEFNTWVGL2RoWDdoRzMvZ1pOZkZnWWhNWEpoNHh0b0VzRVxuLzkzUUpLYXplVjJjMmFLQ09Calc1aTE3NU1mWFk0RURabnFsQjE1MUFvR0FJeTRHMXlwTVVDQzV5OUpDSW5CeFxuREthU2JMQkRyUTMvUHJBUEh5MEJoN0RzMFRVNnhUWUUyK3RZdUFnVm1FcW1jUkZYNlQ3VWtxb0tOZGltL29Va1xuVi8wZzZkZk5DN0MrTTVSd0ZWV2tkT0ZBemZ4YnhqY2FrVlR3TVQyZ1haRStwb0luNmxyaitzanpqczBjNjZMVlxucU1NSWhVbTMvZW5Pa0ppM2NqWlorSG89XG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLAogICJjbGllbnRfZW1haWwiOiAiZmlyZWJhc2UtYWRtaW5zZGstYXJrNWdAZXhpbHVtLTJiN2Q0LmlhbS5nc2VydmljZWFjY291bnQuY29tIiwKICAiY2xpZW50X2lkIjogIjExNTg0MDg5MjE0MjAwOTI2ODE5NyIsCiAgImF1dGhfdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwKICAidG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwKICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsCiAgImNsaWVudF94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvZmlyZWJhc2UtYWRtaW5zZGstYXJrNWclNDBleGlsdW0tMmI3ZDQuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJ1bml2ZXJzZV9kb21haW4iOiAiZ29vZ2xlYXBpcy5jb20iCn0K

# Download dependencies and build a release artifact.
RUN mvn package -DskipTests

# Use OpenJDK for base image.
# https://hub.docker.com/_/openjdk
# https://docs.docker.com/develop/develop-images/multistage-build/#use-multi-stage-builds
FROM openjdk:17-jdk-slim

# Copy the jar to the production image from the builder stage.
COPY --from=build-env /app/target/demo-*.jar /demo.jar

# Expose the port the application runs on
EXPOSE 8080

# Run the web service on container startup.
CMD ["java", "-jar", "/demo.jar"]
